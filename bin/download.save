#!/usr/bin/env bash

set -e

[ -n "$ASDF_INSTALL_VERSION" ] || (echo $'Missing ASDF_INSTALL_VERSION' 1>&2 && exit 1)
[ -n "$ASDF_DOWNLOAD_PATH" ] || (echo $'Missing ASDF_DOWNLOAD_PATH' 1>&2 && exit 1)

command -v go > /dev/null 2>&1 ||
  (echo $'Could not find go executable. Make sure you have go version $_SUPPORTED_GO_VERSION installed.' 1>&2 && exit 1)

_SUPPORTED_GO_VERSION="1.15"
_INSTALLED_GO_VERSION="$(go version | sed -n "s/.*go\([[:digit:]]\+\.[[:digit:]]\+\).*$/\1/p")"

[ "$_INSTALLED_GO_VERSION" == "$_SUPPORTED_GO_VERSION" ] ||
  (echo $'mongo-tools needs to be compiled with $_SUPPORTED_GO_VERSION, but you have $_INSTALLED_GO_VERSION installed.' 1>&2 && exit 1)

unset _SUPPORTED_GO_VERSION _INSTALLED_GO_VERSION

[ -n "$GOROOT" ] || (echo $'Missing GOROOT' 1>&2 && exit 1)

export GOPATH=$ASDF_DOWNLOAD_PATH

(
  mkdir -p "$ASDF_DOWNLOAD_PATH/src/github.com/mongodb/mongo-tools" &&
    curl -fsSL "https://github.com/mongodb/mongo-tools/archive/r$ASDF_INSTALL_VERSION.tar.gz" |
    tar xzf - -C "$ASDF_DOWNLOAD_PATH/src/github.com/mongodb/mongo-tools" --strip-components=1 &&
    ls -lah "$ASDF_DOWNLOAD_PATH/src/github.com/mongodb/mongo-tools"
    exit 0
) || (
  echo $'Download failed' 1>&2 &&
    rm -rf "$ASDF_DOWNLOAD_PATH" &&
    exit 1
)
