#!/usr/bin/env bash

set -e

[ -n "$ASDF_INSTALL_PATH" ] || (echo $'Missing ASDF_INSTALL_PATH' 1>&2 && exit 1)
[ "$ASDF_INSTALL_TYPE" == "version" ] || (echo $'asdf-mongo-tools supports release installs only' 1>&2 && exit 1)

# shellcheck source=bin/download
[ -x "$ASDF_DOWNLOAD_PATH/src/github.com/mongodb/mongo-tools/build.sh" ] || . "$(dirname "$0")/download"

(
  mkdir -p "$ASDF_INSTALL_PATH/bin" &&
    bash -c "$ASDF_DOWNLOAD_PATH/src/github.com/mongodb/mongo-tools/build.sh" &&
    bash -c "$ASDF_DOWNLOAD_PATH/src/github.com/mongodb/mongo-tools/test.sh" &&
    cp "$ASDF_DOWNLOAD_PATH/src/github.com/mongodb/mongo-tools/bin/*" "$ASDF_INSTALL_PATH/bin/" &&
    rm -rf "$ASDF_INSTALL_PATH" "$ASDF_DOWNLOAD_PATH" &&
    echo $'mongo-tools have been installed.' &&
    exit 0
) || (
  rm -rf "$ASDF_INSTALL_PATH" "$ASDF_DOWNLOAD_PATH" &&
    echo $'An error ocurred while installing mongo-tools $ASDF_INSTALL_VERSION' 1>&2 &&
    exit 1
)
